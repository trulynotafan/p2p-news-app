# P2P News App Content

All user-facing content operations for the blog app — posts, profiles, subscriptions, and blog info.

## What it does

- Create and read blog posts
- Manage user profiles and avatars
- Subscribe/unsubscribe to peer blogs
- Read blog metadata (username, drive keys)

**Note:** This is a sub-module of `p2p-news-app`. It handles content operations while the main module handles init, pairing, and infrastructure.

## Quick Start

```javascript
const blog_content = require('p2p-news-app-content')

const content = blog_content(get_state, {
  audit_log,             // function to log audit events
  setup_peer_autobase,   // function to set up peer autobase
  identity               // the vault instance (auto-namespaced by datashell)
})
```

## API

### Posts

```javascript
// Create a post (saved to drive + metadata autobase)
await content.create_post('My Title', 'Post content here...')

// Get your own posts
const my_posts = await content.get_my_posts()

// Get posts from a specific peer
const posts = await content.get_posts(peer_key)

// Get all subscribed peer blogs with their posts
const blogs = await content.get_peer_blogs()
// Returns Map<key, { username, title, drive_key, posts }>
```

### Profiles

```javascript
// Create default profile with username + placeholder avatar
await content.create_default_profile('alice')

// Get profile metadata
const profile = await content.get_profile()
// { name: 'alice', avatar: '/avatar.svg' }

// Get avatar as data URL or SVG string
const avatar = await content.get_avatar_content()

// Upload a new avatar
await content.upload_avatar(imageBuffer, 'photo.jpg')
```

### Subscriptions

```javascript
// Subscribe to a peer's blog
await content.subscribe(peer_hex_key)

// Unsubscribe (closes peer autobase + drive)
await content.unsubscribe(peer_hex_key)

// Low-level subscription data access
const peers = await content.get_subscribed_peers()
await content.add_subscribed_peer(key)
await content.remove_subscribed_peer(key)
```

### Blog Info

```javascript
// Get blog username from metadata
const username = await content.get_blog_username()

// Get drive keys from extended metadata
const profile_key = await content.get_blog_profile_drive_key()
const events_key = await content.get_blog_events_drive_key()
```

## How State Works

This module receives a `get_state()` accessor that returns the app's shared state:

- `ds_manager` — access to data structures (metadata, drive, profile)
- `autobase_cache` — cached peer autobases
- `drive_cache` — cached peer drives
- `discovered_blogs` — Map of discovered peer info
- `emitter` — event emitter for UI updates

## Architecture

```
p2p-news-app
└── p2p-news-app-content
    ├── Post management
    ├── Profile management (avatar, metadata)
    ├── Subscription management
    └── Blog info getters
```

## Key Points

- All vault operations (subscribed peers) go through the namespaced vault — no APP_ID needed
- Audit logging is automatic for posts, avatars, subscriptions
- Profile data lives on a dedicated autodrive (`profile`)
- Posts are stored as JSON files on the `drive`, indexed by the `metadata` autobase
