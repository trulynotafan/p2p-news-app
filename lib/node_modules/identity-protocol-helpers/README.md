# Identity Protocol Helpers

Protomux-based identity exchange protocol. Handles peer-to-peer messaging for sharing autobase keys, relay URLs, and connection metadata.

## What it does

- Defines a Protomux protocol for identity exchange between peers
- Creates message handlers for CLI and browser environments
- Exchanges primary structure keys so peers can discover each other's data
- Shares relay URLs so peers know how to reach each other

**Note:** This is used internally by `identity-networking`. You don't call it directly.

## How it works

When two peers connect over Hyperswarm, this module sets up a Protomux channel called `'identity-exchange'` with two message types:

1. **identity** — sends/receives the peer's primary autobase key
2. **relay_url** — sends/receives the peer's relay URL (browser only)

## API

### identity_exchange_protocol(mux)

Opens a Protomux channel on a connection:

```javascript
const { channel, messages } = identity_exchange_protocol(mux)
// channel: the Protomux channel
// messages: { identity, relay_url } message handlers
```

### create_cli_protocol_handlers(config)

Returns `{ onopen, onmessage_identity }` for CLI connections:

```javascript
const handlers = create_cli_protocol_handlers({
  socket,
  messages,          // from identity_exchange_protocol
  get_primary_key,   // () => hex string of primary key
  store              // corestore to replicate
})
```

### create_browser_protocol_handlers(config)

Returns `{ onopen, onmessage_identity, onmessage_relay }` for browser connections:

```javascript
const handlers = create_browser_protocol_handlers({
  socket,
  messages,
  get_primary_key,
  get_primary_structure,
  store,
  relay               // this peer's relay URL
})
```

## Key Points

- Protocol name: `'identity-exchange'`
- CLI peers exchange keys only, browser peers also exchange relay URLs
- The `store.emit('peer-autobase-key', ...)` event is how the app layer discovers new peers
- All messaging is over Protomux on the existing Hyperswarm socket — no extra connections
