# Identity Networking

P2P networking setup for the identity module. Handles Hyperswarm connections, DHT relay (browser), and protocol exchange.

## What it does

- Starts a Hyperswarm network with optional DHT relay for browsers
- Creates connection handlers for CLI and browser environments
- Manages socket lifecycle (open, error, close)
- Handles identity exchange protocol over Protomux channels

**Note:** This is a sub-module of `identity`. You don't use it directly — identity calls it internally.

## Quick Start

```javascript
const { start_networking } = require('identity-networking')

const { store, swarm, dht, cleanup } = await start_networking({
  name: 'my-peer',
  store_name: 'my-storage',
  topic: Buffer.from('...', 'hex'),
  relay: 'ws://localhost:8080',       // optional, for browser WebRTC
  get_primary_key: () => '...',       // optional, primary structure key
  get_primary_structure: () => {...}  // optional, primary structure
})
```

## How it works

1. Creates/opens a Corestore (filesystem for CLI, IndexedDB for browser)
2. Sets up Hyperswarm (direct for CLI, via DHT relay for browser)
3. Joins the swarm topic
4. On each new connection:
   - Sets up Protomux channels for identity exchange
   - Exchanges primary structure keys + relay URLs
   - Replicates the corestore over the socket

## Connection Handlers

Two handlers depending on environment:

- **CLI** (`create_cli_connection_handler`) — direct TCP connections
- **Browser** (`create_browser_connection_handler`) — WebRTC via relay, includes reconnection logic

Both do the same thing: replicate data and exchange identity info over Protomux.

## Architecture

```
identity module
└── identity-networking
    ├── Hyperswarm setup
    ├── Connection handlers (CLI / browser)
    ├── Socket lifecycle management
    └── Uses identity-protocol-helpers for Protomux messaging
```

## Key Points

- Browser connections go through a DHT relay (WebSocket → WebRTC)
- CLI connections are direct TCP via Hyperswarm
- The module is stateless — takes options, returns networking instances
- Protocol exchange happens automatically on every new peer connection
