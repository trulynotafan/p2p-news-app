// Identity Networking - creates swarm + replicates store on connection
const Hyperswarm = require('hyperswarm')
const DHT = require('@hyperswarm/dht-relay')
const Stream = require('@hyperswarm/dht-relay/ws')

module.exports = { network }

const is_cli = typeof globalThis.open === 'undefined'

// store for replication
// mnemonic data to join the swarm with a determinstic keypair
async function network (store, mnemonic_data) {
  await store.ready()
  const swarm = await create_swarm(store, mnemonic_data)
  console.log('[identity] swarm joined')
  // for now its replicating the entire store, but this connection is only between our own devices
  swarm.on('connection', (socket) => store.replicate(socket))
  return { swarm }
}

async function create_swarm (store, mnemonic_data) {
  if (is_cli) {
    const swarm = new Hyperswarm({ keyPair: mnemonic_data.keypair })
    store.swarm = swarm
    return swarm
  }

  const is_dev = location.hostname === 'localhost' || location.hostname.startsWith('192.') || location.hostname.startsWith('10.')
  const relay_url = is_dev ? 'ws://localhost:8080' : 'wss://relay-production-9c0e.up.railway.app'

  return new Promise((resolve, reject) => {
    const socket = new WebSocket(relay_url)
    const resolved = { value: false }

    function on_error (err) {
      if (resolved.value) return
      resolved.value = true
      reject(new Error(`Relay connection failed: ${relay_url} - ${err?.message || 'Connection error'}`))
    }

    socket.addEventListener('error', on_error)
    socket.addEventListener('close', on_error)
    socket.addEventListener('open', async () => {
      try {
        if (resolved.value) return
        resolved.value = true
        if (socket.readyState !== WebSocket.OPEN) return
        const stream = new Stream(true, socket)
        const dht = new DHT(stream)
        const swarm = new Hyperswarm({ dht, keyPair: mnemonic_data.keypair })
        store.swarm = swarm
        resolve(swarm)
      } catch (error) {
        reject(error)
      }
    })
  })
}
