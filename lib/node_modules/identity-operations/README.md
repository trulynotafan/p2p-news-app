# Identity Operations

Vault data operations for the identity module. Handles audited read/write, app registration, event logging, device management, writer access, and raw data inspection.

## What it does

- Audited vault read/write (every put/get/del is logged)
- App registration with automatic auditcore creation
- Event logging to an events drive
- Device management (list, name, remove paired devices)
- Writer access management (watch, request, wait, bootstrap)
- Raw data inspection for debugging

**Note:** This is a sub-module of `identity`. The app interacts with it through the identity API, which the datashell auto-namespaces per app.

## API

### Vault Data Operations

```javascript
// All operations are audit-logged automatically
await vault.vault_put('my-key', { some: 'data' })
const data = await vault.vault_get('my-key')
await vault.vault_del('my-key')
```

### App Registration

```javascript
// Register an app with the vault (creates an auditcore for the app)
await vault.register_app(app_id, {
  name: 'My App',
  structures: [
    { name: 'posts', namespace: 'app-posts', type: 'autobase', key: '...' },
    { name: 'files', namespace: 'app-files', type: 'autodrive', key: '...' }
  ]
})

// Get app config back
const app = await vault.get_app(app_id)

// Load app audit on a pairing device
await vault.load_app_audit(app_id, app.audit_key)
```

### Event Logging

```javascript
// Log a device event
await vault.log_event(events_drive, 'add', {
  metadata_writer: '...',
  drive_writer: '...'
})

// Read all events
const events = await vault.get_events(events_drive)
```

### Device Management

```javascript
const devices = await vault.get_paired_devices(events_drive)
const name = await vault.get_device_name(events_drive, writer_key)
await vault.remove_device(events_drive, device)
```

### Writer Access Management

Handles multi-device writer key exchange automatically:

```javascript
// Device A: start watching for writer requests
vault.start_writer_watcher(app_id)

// Device B: request writer access (submits local writer keys)
await vault.request_writer_access(app_id)

// Device B: wait until Device A processes the request
await vault.wait_for_writer_access(app_id)

// Log the first (bootstrap) device
await vault.log_bootstrap_device(app_id)
```

### Raw Data Inspection

```javascript
// Dump raw contents of any structure (useful for debugging)
const raw = await vault.get_raw_data('metadata')
console.log(raw)
```

## Architecture

```
identity module
└── identity-operations
    ├── Audited vault read/write
    ├── App registration + auditcore
    ├── Event logging
    ├── Device management
    ├── Writer access management
    └── Raw data inspection
```

## How State Works

This module receives a `get_state()` accessor from the identity module. It reads `vault_bee`, `vault_audit`, `ds_manager`, `app_audits`, `emitter`, and `events_drive` from the shared state without tight coupling.

## Key Points

- Every vault write operation is audit-logged
- Writer access management is fully generic — works for any app
- The datashell wraps these calls so apps never pass `app_id` directly
- Raw data inspection works on any structure type (autobase, autodrive, auditcore)
