let STATE
try {
    STATE = require('STATE')
} catch (e) {
    STATE = window.STATE
}
if (!STATE || typeof STATE !== 'function') {
    if (window.STATE) STATE = window.STATE
    else console.warn('STATE module not found via require or window')
}

const statedb = STATE ? STATE(__filename) : null
const { get } = statedb ? statedb(fallback_module) : { get: async () => ({ id: 0, sdb: { drive: { get: async () => null }, watch: async () => [] } }) }
const graph_explorer = require('graph-explorer')
const graphdb = require('./graphdb')

module.exports = my_component_with_graph

async function my_component_with_graph(opts, protocol) {
    const { id, sdb } = await get(opts.sid)
    const { drive } = sdb

    const ids = opts.ids
    if (!ids || !ids.up) {
        // throw new Error(`Component ${__filename} requires ids.up to be provided`)
    }

    const by = id
    let db = null
    let send_to_graph_explorer = null
    let mid = 0

    const on = {
        theme: inject,
        entries: on_entries
    }

    const el = document.createElement('div')
    el.style.height = '100%'
    el.style.width = '100%'
    const shadow = el.attachShadow({ mode: 'closed' })
    const sheet = new CSSStyleSheet()
    shadow.adoptedStyleSheets = [sheet]

    const subs = await sdb.watch(onbatch)
    const explorer_el = await graph_explorer(subs[0], graph_explorer_protocol)
    shadow.append(explorer_el)

    return el

    async function onbatch(batch) {
        for (const { type, paths } of batch) {
            const data = await Promise.all(paths.map(path => drive.get(path).then(file => file ? file.raw : null)))
            const valid_data = data.filter(d => d !== null)
            if (valid_data.length > 0) {
                on[type] && on[type](valid_data)
            }
        }
    }

    function inject(data) {
        sheet.replaceSync(data.join('\n'))
    }

    function on_entries(data) {
        if (!data || !data[0]) {
            // console.error('Entries data is missing or empty.')
            db = graphdb({})
            notify_db_initialized({})
            return
        }

        let parsed_data
        try {
            parsed_data = typeof data[0] === 'string' ? JSON.parse(data[0]) : data[0]
        } catch (e) {
            console.error('Failed to parse entries data:', e)
            parsed_data = {}
        }

        if (typeof parsed_data !== 'object' || !parsed_data) {
            console.error('Parsed entries data is not a valid object.')
            parsed_data = {}
        }

        db = graphdb(parsed_data)
        notify_db_initialized(parsed_data)
    }

    function notify_db_initialized(entries) {
        if (send_to_graph_explorer) {
            const head = [by, 'graph_explorer', mid++]
            send_to_graph_explorer({
                head,
                type: 'db_initialized',
                data: { entries }
            })
        }
    }

    function graph_explorer_protocol(send) {
        send_to_graph_explorer = send
        return on_graph_explorer_message

        function on_graph_explorer_message(msg) {
            const { type } = msg
            if (type.startsWith('db_')) {
                handle_db_request(msg, send)
            }
        }

        function handle_db_request(request_msg, send) {
            const { head: request_head, type: operation, data: params } = request_msg
            let result

            if (!db) {
                // console.error('[my_component] Database not initialized yet')
                send_response(request_head, null)
                return
            }

            if (operation === 'db_get') {
                result = db.get(params.path)
            } else if (operation === 'db_has') {
                result = db.has(params.path)
            } else if (operation === 'db_is_empty') {
                result = db.is_empty()
            } else if (operation === 'db_root') {
                result = db.root()
            } else if (operation === 'db_keys') {
                result = db.keys()
            } else if (operation === 'db_raw') {
                result = db.raw()
            } else {
                console.warn('[my_component] Unknown db operation:', operation)
                result = null
            }

            send_response(request_head, result)

            function send_response(request_head, result) {
                const response_head = [by, 'graph_explorer', mid++]
                send({
                    head: response_head,
                    refs: { cause: request_head },
                    type: 'db_response',
                    data: { result }
                })
            }
        }
    }
}

function fallback_module() {
    return {
        _: {
            'graph-explorer': { $: '' },
            './graphdb': { $: '' }
        },
        api: fallback_instance
    }

    function fallback_instance() {
        return {
            _: {
                'graph-explorer': {
                    $: '',
                    0: '',
                    mapping: {
                        style: 'theme',
                        runtime: 'runtime',
                        mode: 'mode',
                        flags: 'flags',
                        keybinds: 'keybinds',
                        undo: 'undo'
                    }
                },
                './graphdb': {
                    $: ''
                }
            },
            drive: {
                'theme/': {
                    'style.css': {
                        raw: `
              :host {
                display: block;
                height: 100%;
                width: 100%;
              }
              .graph-container {
                color: #abb2bf;
                background-color: #282c34;
                padding: 10px;
                height: 100vh;
                overflow: auto;
              }
              .node {
                display: flex;
                align-items: center;
                white-space: nowrap;
                cursor: default;
                height: 22px;
              }
              .clickable {
                cursor: pointer;
              }
              .node.type-folder > .icon::before { content: 'ðŸ“'; }
              .node.type-js-file > .icon::before { content: 'ðŸ“œ'; }
              .node.type-file > .icon::before { content: 'ðŸ“„'; }
            `
                    }
                },
                'entries/': {
                    'entries.json': {
                        $ref: 'entries.json'
                    }
                },
                'runtime/': {},
                'mode/': {},
                'flags/': {},
                'keybinds/': {},
                'undo/': {}
            }
        }
    }
}
