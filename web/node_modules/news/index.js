const blog_app = require('p2p-news-app')
const wrapper = require('./wrapper')
const STATE = require('STATE')
const statedb = STATE(__filename)
const { get } = statedb(fallback_module)

module.exports = function news_app(vault) {
    const container = document.createElement('div')
    container.className = 'app-container'

    // Inject styles
    const styleEl = document.createElement('style')
    styleEl.textContent = `
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      height: 100vh;
      display: flex;
      overflow: hidden;
    }

    .app-container {
      display: flex;
      width: 100%;
      height: 100%;
    }

    .sidebar {
      width: 300px;
      border-right: 1px solid #e0e0e0;
      background: #f9f9f9;
      display: flex;
      flex-direction: column;
      height: 100%;
      overflow: hidden;
    }

    .main-content {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      background: #fff;
    }

    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100%;
      color: #666;
    }
  `
    document.head.appendChild(styleEl)

    // Sidebar container
    const sidebar = document.createElement('div')
    sidebar.className = 'sidebar'
    container.appendChild(sidebar)

    // Main content container
    const main = document.createElement('div')
    main.className = 'main-content'
    main.innerHTML = '<h1>Select a feed to view posts</h1>'
    container.appendChild(main)

    // Initialize App
    init(vault, sidebar, main)

    return container
}

async function init(vault, sidebarEl, mainEl) {
    try {
        // Initialize API
        const api = blog_app(vault)

        // We need to init the blog to get the store and swarm
        // Check for existing username
        let username = localStorage.getItem('username')
        if (!username) {
            username = prompt('Enter your username:')
            if (username) localStorage.setItem('username', username)
            else return
        }

        // Init blog
        await api.init_blog({ username })

        // Data Transformation Logic
        const get_entries = async () => {
            const entries = {
                '/': { name: 'P2P News', type: 'root', subs: ['/feeds', '/my-blog'], hubs: [] },
                '/feeds': { name: 'Feeds', type: 'folder', subs: [] },
                '/my-blog': { name: 'My Blog', type: 'folder', subs: [] }
            }

            // Get subscribed peers
            const peer_blogs = await api.get_peer_blogs()

            for (const [key, blog] of peer_blogs) {
                const path = `/feeds/${key}`
                const profile = await api.get_profile(key)
                const name = profile ? profile.name : blog.username

                entries['/feeds'].subs.push(path)
                entries[path] = {
                    name: name,
                    type: 'feed',
                    subs: []
                }

                // Add posts as children
                if (blog.posts) {
                    blog.posts.forEach((post, index) => {
                        const post_path = `${path}/${index}`
                        entries[path].subs.push(post_path)
                        entries[post_path] = {
                            name: post.title,
                            type: 'post',
                            data: post // Store full post data
                        }
                    })
                }
            }

            // Get my posts
            const my_posts = await api.get_my_posts()
            my_posts.forEach((post, index) => {
                const path = `/my-blog/${index}`
                entries['/my-blog'].subs.push(path)
                entries[path] = {
                    name: post.title,
                    type: 'post',
                    data: post
                }
            })

            return entries
        }

        // Initialize STATE and populate drive
        const { id, sdb } = await get() // Get default session
        const { drive } = sdb

        // Write entries to drive
        const entries = await get_entries()
        // We need to write it as a file
        // drive.put expects buffer or string?
        // In fallback, it's { $ref: 'entries.json' }.
        // If we write 'entries/entries.json', the wrapper will read it.
        // Wait, the wrapper reads 'entries/' directory.
        // And then reads each file.
        // So we should write 'entries/entries.json'.

        // Note: sdb.drive might be an autodrive or similar.
        // Assuming it supports `put(path, content)`.
        await drive.put('entries/entries.json', JSON.stringify(entries))

        // Initialize Sidebar with the same session ID
        const sidebar_component = await wrapper({
            id: 'sidebar',
            sid: id, // Pass our session ID so wrapper gets the same drive
            ids: { up: 'host' }
        }, (send) => {
            // Protocol handler for host (us)
            // We receive messages from the sidebar here
            return (msg) => {
                // console.log('[Host] Received:', msg)
                // Handle selection
                // Note: The placeholder/wrapper might not send selection events yet
                // But if it did, we would update mainEl here
            }
        })

        sidebarEl.appendChild(sidebar_component)

        // Listen for updates
        api.on_update(async () => {
            // Refresh sidebar data
            console.log('Data updated, refreshing sidebar...')
            const updated_entries = await get_entries()
            await drive.put('entries/entries.json', JSON.stringify(updated_entries))
        })

    } catch (err) {
        console.error('Error initializing news app:', err)
        mainEl.innerHTML = `<p style="color:red">Error: ${err.message}</p>`
    }
}

function fallback_module() {
    return {
        _: {
            './wrapper': { $: '' }
        },
        api: fallback_instance
    }

    function fallback_instance() {
        return {
            _: {
                './wrapper': { $: '' }
            },
            drive: {
                'entries/': {},
                'theme/': {}
            }
        }
    }
}
