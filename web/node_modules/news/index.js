const STATE = require('STATE')
const statedb = STATE(__filename)
const { get } = statedb(defaults)
const wrapper = require('./wrapper')

module.exports = news_app

async function news_app(opts = {}) {
  const { sid, vault } = opts

  const container = document.createElement('div')
  container.className = 'container'

  container.innerHTML = `
    <div class="sidebar"></div>
    <div class="main"></div>
  `

  const sidebar_el = container.querySelector('.sidebar')
  const main_el = container.querySelector('.main')

  await init(vault, sidebar_el, main_el, sid, container)

  return container
}

async function init(vault, sidebar_el, main_el, sid, container) {
  const { id, sdb } = await get(sid)

  if (sdb && sdb.drive) {
    const css_file = await sdb.drive.get('theme/shell.css').catch(() => null)
    if (css_file && css_file.raw) {
      const style = document.createElement('style')
      style.textContent = css_file.raw
      container.appendChild(style)
    }
  }

  const subs = await sdb.watch(async (batch) => {
  })

  if (!subs || subs.length === 0) {
    console.error('[news/index.js] No active instances found for wrapper')
    return
  }

  const wrapper_instance = subs[0]
  const { sid: wrapper_sid } = wrapper_instance

  const sidebar_component = await wrapper({
    id: 'sidebar',
    sid: wrapper_sid,
    ids: { up: id }
  }, (send) => {
    return (msg) => {
      console.log('Host received:', msg)
    }
  })

  sidebar_el.appendChild(sidebar_component)
}

function defaults(opts) {
  const _ = {
    './wrapper': { $: '' }
  }

  return { _, api }

  function api(opts) {
    const _ = {
      './wrapper': {
        0: '',
        mapping: {
          theme: 'theme',
          entries: 'entries',
          runtime: 'runtime',
          mode: 'mode',
          flags: 'flags',
          keybinds: 'keybinds',
          undo: 'undo',
          'my-stories': 'my-stories',
          feeds: 'feeds',
          lists: 'lists',
          discover: 'discover'
        }
      }
    }

    const drive = {
      'entries/': {
        'entries.json': {
          $ref: 'entries.json'
        }
      },
      'theme/': {
        'shell.css': {
          raw: `
    body { margin: 0; padding: 0; overflow: hidden; }
    .container {
      display: flex;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }
    .sidebar {
      width: 250px;
      min-width: 250px;
      border-right: 1px solid #e5e7eb;
      background: #f9fafb;
      display: flex;
      flex-direction: column;
    }
    .main {
      flex: 1;
      overflow: auto;
      padding: 2rem;
      background: #ffffff;
    }
                `
        }
      },
      'runtime/': {},
      'mode/': {},
      'flags/': {},
      'keybinds/': {},
      'undo/': {},
      'my-stories/': {},
      'feeds/': {},
      'lists/': {},
      'discover/': {}
    }

    return { _, drive }
  }
}

