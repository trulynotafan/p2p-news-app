const wrapper = require('./wrapper')
const STATE = require('STATE')
const statedb = STATE(__filename)
const { get } = statedb(fallback_module)

module.exports = function news_app(opts = {}) {
    const { sid = 0, vault } = opts
    const container = document.createElement('div')
    container.className = 'app-container'


    const styleEl = document.createElement('style')
    styleEl.textContent = `
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      height: 100vh;
      display: flex;
      overflow: hidden;
    }

    .app-container {
      display: flex;
      width: 100%;
      height: 100%;
    }

    .sidebar {
      width: 300px;
      border-right: 1px solid #e0e0e0;
      background: #f9f9f9;
      display: flex;
      flex-direction: column;
      height: 100%;
      overflow: hidden;
    }

    .main-content {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      background: #fff;
    }

    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100%;
      color: #666;
    }
  `
    document.head.appendChild(styleEl)


    const sidebar = document.createElement('div')
    sidebar.className = 'sidebar'
    container.appendChild(sidebar)


    const main = document.createElement('div')
    main.className = 'main-content'
    main.innerHTML = '<h1>Select a feed to view posts</h1>'
    container.appendChild(main)


    init(vault, sidebar, main)

    return container
}

async function init(vault, sidebarEl, mainEl) {
    try {

        const api = blog_app(vault)


        let username = localStorage.getItem('username')
        if (!username) {
            username = prompt('Enter your username:')
            if (username) localStorage.setItem('username', username)
            else return
        }


        await api.init_blog({ username })

        const get_entries = async () => {
            const entries = {
                '/': { name: 'P2P News', type: 'root', subs: ['/my-stories', '/feeds', '/lists', '/discover'], hubs: [] },
                '/my-stories': { name: 'My Stories', type: 'folder', subs: [] },
                '/feeds': { name: 'Feeds', type: 'folder', subs: [] },
                '/lists': { name: 'Lists', type: 'folder', subs: [] },
                '/discover': { name: 'Discover', type: 'folder', subs: [] }
            }


            const peer_blogs = await api.get_peer_blogs()

            for (const [key, blog] of peer_blogs) {
                const path = `/feeds/${key}`
                const profile = await api.get_profile(key)
                const name = profile ? profile.name : blog.username

                entries['/feeds'].subs.push(path)
                entries[path] = {
                    name: name,
                    type: 'feed',
                    subs: []
                }


                if (blog.posts) {
                    blog.posts.forEach((post, index) => {
                        const post_path = `${path}/${index}`
                        entries[path].subs.push(post_path)
                        entries[post_path] = {
                            name: post.title,
                            type: 'post',
                            data: post
                        }
                    })
                }
            }


            const my_posts = await api.get_my_posts()
            my_posts.forEach((post, index) => {
                const path = `/my-stories/${index}`
                entries['/my-stories'].subs.push(path)
                entries[path] = {
                    name: post.title,
                    type: 'post',
                    data: post
                }
            })

            return entries
        }

        const { id, sdb } = await get()
        const { drive } = sdb


        const entries = await get_entries()

        await drive.put('entries/entries.json', JSON.stringify(entries))


        const sidebar_component = await wrapper({
            id: 'sidebar',
            sid: id,
            ids: { up: 'host' }
        }, (send) => {
            return (msg) => {
                console.log('Host received:', msg)
            }
        })

        sidebarEl.appendChild(sidebar_component)


        api.on_update(async () => {
            console.log('Data updated, refreshing sidebar...')
            const updated_entries = await get_entries()
            await drive.put('entries/entries.json', JSON.stringify(updated_entries))
        })

    } catch (err) {
        console.error('Error initializing news app:', err)
        mainEl.innerHTML = `<p style="color:red">Error: ${err.message}</p>`
    }
}

function fallback_module() {
    return {
        _: {
            './wrapper': { $: '' }
        },
        api: fallback_instance
    }

    function fallback_instance() {
        return {
            _: {
                './wrapper': { $: '' }
            },
            drive: {
                'entries/': {},
                'theme/': {}
            }
        }
    }
}