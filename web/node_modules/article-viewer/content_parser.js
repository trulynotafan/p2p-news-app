module.exports = function content_parser (raw) {
  if (!raw) return null

  try {
    const data = JSON.parse(raw)
    if (data && typeof data === 'object') return data
  } catch (e) { }

  const fm_regex = /^---\n([\s\S]*?)\n---\n([\s\S]*)$/
  const match = raw.match(fm_regex)

  if (match) {
    const metadata_str = match[1]
    const content = match[2]
    const metadata = {}

    metadata_str.split('\n').forEach(parse_metadata_line)

    function parse_metadata_line (line) {
      const colon_index = line.indexOf(':')
      if (colon_index !== -1) {
        const key = line.slice(0, colon_index).trim()
        let value = line.slice(colon_index + 1).trim()

        if ((value.startsWith('"') && value.endsWith('"')) || (value.startsWith("'") && value.endsWith("'"))) {
          value = value.slice(1, -1)
        }

        if (value.startsWith('[') && value.endsWith(']')) {
          value = value.slice(1, -1).split(',').map(trim_and_unquote)
        }

        metadata[key] = value
      }
    }

    function trim_and_unquote (s) {
      s = s.trim()
      if ((s.startsWith('"') && s.endsWith('"')) || (s.startsWith("'") && s.endsWith("'"))) {
        return s.slice(1, -1)
      }
      return s
    }

    return { ...metadata, content: content.trim() }
  }

  return { content: raw }
}
